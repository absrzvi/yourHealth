generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  reports      Report[]
  insights     WeeklyInsight[]
  chatMessages ChatMessage[]
}

model Report {
  id         String     @id @default(cuid())
  userId     String
  type       String
  fileName   String
  filePath   String
  parsedData String?
  testDate   DateTime?
  labName    String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  user       User       @relation(fields: [userId], references: [id])
  biomarkers Biomarker[]
  
  @@index([userId])
  @@index([type])
  @@index([testDate])
}

model Biomarker {
  id          String    @id @default(cuid())
  reportId    String
  name        String
  value       Float
  unit        String?
  range       String?
  flag        String?
  description String?
  category    String?
  report      Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  @@index([reportId])
  @@index([name])
  @@index([category])
}

model WeeklyInsight {
  id                    String   @id @default(cuid())
  userId                String
  weekNumber            Int
  year                  Int
  cardiovascularScore   Float?
  metabolicScore        Float?
  inflammationScore     Float?
  recommendations       String?
  generatedAt           DateTime @default(now())
  user                  User     @relation(fields: [userId], references: [id])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  content   String
  role      String
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

model AuditLog {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  action       String
  resourceType String    @map("resource_type")
  resourceId   String?   @map("resource_id")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  metadata     String?   @default("{}")
  timestamp    DateTime  @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([timestamp])
  
  @@map("audit_log")
}

